commit 7edf904a62c822ba47318761ab915291db836643
Author: David Woodhouse <David.Woodhouse@intel.com>
Date:   Sat Oct 3 09:59:25 2009 +0100

    Fix bye packet length
    
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>

commit ba5e72ace013b15325d022c08f9006995d2f928e
Author: David Woodhouse <David.Woodhouse@intel.com>
Date:   Thu Sep 17 13:48:45 2009 +0100

    Fix disconnect packet
    
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>

--- a/cstp.c
+++ b/cstp.c
@@ -678,18 +678,19 @@ int cstp_bye(struct openconnect_info *vpninfo, char *reason)
 		return 0;
 
 	reason_len = strlen(reason);
-	bye_pkt = malloc(reason_len + 8);
+	bye_pkt = malloc(reason_len + 9);
 	if (!bye_pkt)
 		return -ENOMEM;
 
 	memcpy(bye_pkt, data_hdr, 8);
-	memcpy(bye_pkt + 8, reason, reason_len);
+	memcpy(bye_pkt + 9, reason, reason_len);
 
-	bye_pkt[4] = reason_len >> 8;
-	bye_pkt[5] = reason_len & 0xff;
+	bye_pkt[4] = (reason_len + 1) >> 8;
+	bye_pkt[5] = (reason_len + 1) & 0xff;
 	bye_pkt[6] = AC_PKT_DISCONN;
+	bye_pkt[8] = 0xb0;
 
-	SSL_write(vpninfo->https_ssl, bye_pkt, reason_len + 8);
+	SSL_write(vpninfo->https_ssl, bye_pkt, reason_len + 9);
 	free(bye_pkt);
 
 	vpninfo->progress(vpninfo, PRG_INFO,
